(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{5:function(e,t,n){"use strict";n.r(t);var s=n(37),i=n.n(s),o=n(65),r=n.n(o),a=function(e,t){return{type:e,username:t}},u={data:function(){return{user:a(),sid:void 0,server:void 0,chats:[],db:null,_refreshChatsLoopTimeout:null}},methods:{init:function(e){this.server=i()(e,{autoConnect:!1}),this.server.on("connect",this._onConnectionStateChange.bind(this,!0)),this.server.on("disconnect",this._onConnectionStateChange.bind(this,!1)),this.server.on("newMessage",this._onNewMessage),this.server.on("isTypingFlag",this._onIsTypingFlag),this.server.on("connetedToRandomUser",this._onConnetedToRandomUser),this.server.open(),this.startRefreshChatsLoop()},login:function(e){var t=this;return new Promise((function(n,s){t.server.emit("auth",e,(function(e,i){e?s(e):(t.user=a(i.type,i.username),r()({name:"".concat(JSON.stringify(t.user),".db"),memory:!1,browser:!0,collections:["chats"]}).then((function(e){t.db=e,t._loadChats(),t.$emit("login",i.type,i.username),setTimeout((function(){t.server.emit("askForPendingMessages",(function(){}))})),n()})))}))}))},logout:function(){var e=this;this._clearChats(),setTimeout((function(){e.user=a(),e.$emit("logout"),location.reload()}),1e3)},connectToRandomUser:function(){var e=this;return new Promise((function(t,n){e.server.emit("connectToRandomUser",(function(s,i){if(s||!i)n(s);else{var o=e._upsertChat(i.type,i.username);e._saveChats(),t(o)}}))}))},cancelConnectToRandomUser:function(){var e=this;return new Promise((function(t){e.server.emit("cancelConnectToRandomUser",(function(e){t()}))}))},_onConnetedToRandomUser:function(e){var t=e.type,n=e.username,s=this._upsertChat(t,n);this._saveChats(),this.$emit("connetedToRandomUser",s)},sendMessage:function(e,t){var n=this;return new Promise((function(s,i){n.server.emit("sendMessage",{user:e.user,body:t},(function(t,o){t&&i(t),e.messages.push({from:"me",body:o.body,date:o.date}),n._saveChats(),s()}))}))},sendIsTypingFlag:function(e){var t=this;return new Promise((function(n,s){t.server.emit("sendIsTypingFlag",{user:{type:e.user.type,username:e.user.username}},(function(e){e?s():n()}))}))},_onIsTypingFlag:function(e){this.$emit("isTypingFlag",e)},getChat:function(e){var t=e.type,n=e.username;return this._upsertChat(t,n)},deleteChat:function(e){this.chats.splice(this.chats.indexOf(e),1),this.db.chats.remove((function(t){return t.user.type===e.user.type&&t.user.username===e.user.username}))},refreshChat:function(e){var t=this;return new Promise((function(n){t.server.emit("getUserStatus",e.user,(function(t,s){e.isOnline=!t&&s,n(e.isOnline)}))}))},startRefreshChatsLoop:function(){var e=this;clearTimeout(this._refreshChatsLoopTimeout),this.chats.forEach((function(t){e.refreshChat(t)})),this._refreshChatsLoopTimeout=setTimeout((function(){e.startRefreshChatsLoop()}),1e4)},_onNewMessage:function(e){var t=e.from,n=t.type,s=t.username,i=e.body,o=e.date,r=this._upsertChat(n,s);r.isOnline=!0,r.messages.push({from:"its",body:i,date:o}),this._saveChats(),this.$emit("newMessage",{user:a(n,s),body:i,date:o})},_saveChats:function(){var e=this;"persist"===this.user.type&&this.db&&setTimeout((function(){e.chats.forEach((function(t){try{e.db.chats.update(t)}catch(n){e.db.chats.insert(t)}}))}))},_loadChats:function(){"persist"===this.user.type&&this.db?(this.chats=this.db.chats.find((function(){return!0})).map((function(e){return e.isOnline=null,JSON.parse(JSON.stringify(e))})),this.startRefreshChatsLoop()):this.chats=[]},_clearChats:function(){this.chats=[]},_onConnectionStateChange:function(e){!0===e?(this.sid=this.server.id,this.$emit("connect",this.sid)):(location.reload(),this.$emit("disconnect"))},_upsertChat:function(e,t){var n=this.chats.find((function(n){return n.user.type===e&&n.user.username===t}));return n||(n={user:a(e,t),isOnline:null,messages:[],pendingMessages:[],badge:0},this.chats.unshift(n)),n}}};t.default=u},62:function(e,t){},65:function(e,t,n){var s=n(66),i=n(34);e.exports=function(e){var t=e.name,n=e.memory,o=void 0!==n&&n,r=e.browser,a=void 0!==r&&r,u=e.syncToCloud,c=void 0!==u&&u,h=e.collections,f=void 0===h?[]:h;return new Promise((function(e){var n,r=function(){var t={};f.forEach((function(e){var s;t[e]=(s=n,function(e){var t=s.getCollection(e)||s.addCollection(e);return{insert:function(e){return setTimeout(m),t.insert(e)},find:function(e){return t.where(e)},remove:function(e){return"function"==typeof e?t.removeWhere(e):(setTimeout(m),t.remove(e))},update:function(e,n){return"function"==typeof e?t.updateWhere(e,n):(setTimeout(m),t.update(e))}}})(e)})),e(t)},u=null,h=!1,d=function(){if(!h)return clearTimeout(u),u=setTimeout((function(){h=!0,c().then((function(){h=!1})).catch((function(){(function(e){throw new Error('"'+e+'" is read-only')})("saveToCloud"),d=!1}))}),1e4),!0},m=function(){n&&!o&&n.save(),n&&!o&&c&&d()},l={};o||(l.autoload=!0,l.autoloadCallback=r),a&&(l.adapter=new i),new Promise((function(e,t){e()})).then((function(){n=new s(t,l),o&&r()}))}))}}}]);